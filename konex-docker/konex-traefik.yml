version: "3.7"

services:
  konex-app:
    image: konex/konex-crm:latest
    restart: on-failure
    environment:
      # =====================
      # AMBIENTE
      # =====================
      RAILS_ENV: production
      TZ: America/Sao_Paulo
      LANGUAGE: "pt-BR"
      DEFAULT_TIMEZONE: "America/Sao_Paulo"

      # =====================
      # BANCO DE DADOS
      # =====================
      DATABASE_URL: postgres://POSTGRES_USER:POSTGRES_PASSWORD@POSTGRES_HOST:5432/konex_crm

      # =====================
      # REDIS
      # =====================
      REDIS_URL: redis://REDIS_USER:REDIS_PASSWORD@REDIS_HOST:6379/0

      # =====================
      # KONEX – CONFIGURAÇÕES
      # =====================
      FRONTEND_URL: "https://konex.seudominio.com"
      GOOD_JOB_EXECUTION_MODE: "external"

      ENABLE_USER_SIGNUP: "false"
      SWAGGER_ENABLED: "true"

      # =====================
      # MOTOR ADMIN
      # =====================
      MOTOR_AUTH_USERNAME: "admin"
      MOTOR_AUTH_PASSWORD: "MUDAR_SENHA"

    labels:
      # =====================
      # TRAEFIK
      # =====================
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTPS
      - "traefik.http.routers.konex.rule=Host(`konex.seudominio.com`)"
      - "traefik.http.routers.konex.entrypoints=websecure"
      - "traefik.http.routers.konex.tls.certresolver=letsencrypt"
      - "traefik.http.services.konex.loadbalancer.server.port=3000"

      # HTTP → HTTPS
      - "traefik.http.routers.konex-http.rule=Host(`konex.seudominio.com`)"
      - "traefik.http.routers.konex-http.entrypoints=web"
      - "traefik.http.routers.konex-http.middlewares=konex-redirect-https"

      - "traefik.http.middlewares.konex-redirect-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.konex-redirect-https.redirectscheme.permanent=true"

    networks:
      - traefik

  konex-worker:
    image: konex/konex-crm:latest
    command: bundle exec sidekiq
    restart: on-failure
    environment:
      RAILS_ENV: production
      TZ: America/Sao_Paulo
      LANGUAGE: "pt-BR"
      DEFAULT_TIMEZONE: "America/Sao_Paulo"

      DATABASE_URL: postgres://POSTGRES_USER:POSTGRES_PASSWORD@POSTGRES_HOST:5432/konex_crm
      REDIS_URL: redis://REDIS_USER:REDIS_PASSWORD@REDIS_HOST:6379/0

      GOOD_JOB_EXECUTION_MODE: external

    networks:
      - traefik

networks:
  traefik:
    external: true
